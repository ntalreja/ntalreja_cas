formatVersion: 1
inputs:
  MachineName:
    type: string
    title: Name for the VM
    description: Enter Name for VM.
  isopath:
    type: string
  dirpath:
    type: string
  ps1path:
    type: string
resources:
  Cloud_vSphere_Machine_1:
    type: Cloud.vSphere.Machine
    properties:
      image: WIndows-Base
      cpuCount: 2
      totalMemoryMB: 2048
      customizationSpec: Windows-base
      newName: '${input.MachineName}'
      networks:
        - network: '${resource.Cloud_vSphere_Network_1.id}'
      constraints:
        - tag: 'env:vsphere'
      tags:
        - key: app
          value: sql
  Cloud_vSphere_Network_1:
    type: Cloud.vSphere.Network
    properties:
      networkType: existing
      constraints:
        - tag: 'env:vsphere'
  Install SQL\SMSS:
    type: Custom.script
    dependsOn:
      - Cloud_vSphere_Machine_1
    properties:
      vcuser: mcclanahanc@cmbu.local
      vcpassword: ***
      vcfqdn: ***
      remoteuser: administrator
      remotepassword: VMware1!
      machinename: '${resource.Cloud_vSphere_Machine_1.resourceName}'
      script: |
        Install-WindowsFeature -name Web-Server -IncludeManagementTools
        New-Item $env:SystemDrive\powershell_multipart_1.txt -type file -ErrorAction SilentlyContinue
        $ImagePath = '${input.isopath}'
        $DIR = '${input.dirpath}'
        New-Item -Path $DIR -ItemType Directory
        Copy-Item -Path (Join-Path -Path (Get-PSDrive -Name ((Mount-DiskImage -ImagePath $ImagePath -PassThru) | Get-Volume).DriveLetter).Root -ChildPath '*') -Destination $DIR -Recurse
        Dismount-DiskImage -ImagePath $ImagePath
        [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
        Get-PackageProvider -Name NuGet -ForceBootstrap
        Install-Module -Name SqlServerDsc -Force
        Copy-Item '${input.ps1path}' -Destination "c:\"
        cd c:\
        ./sqlserverconfig.ps1
        Start-DscConfiguration -Path C:\sqlserverconfig -Wait -Force -Verbose
        Start-Sleep -s 180
        Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))
        choco install sql-server-management-studio -yes
      reboot: 1
  Create Table:
    type: Custom.script
    dependsOn:
      - Install SQL\SMSS
    properties:
      vcuser: mcclanahanc@cmbu.local
      vcpassword: ***
      vcfqdn: ****
      remoteuser: administrator
      remotepassword: VMware1!
      machinename: '${resource.Cloud_vSphere_Machine_1.resourceName}'
      script: |
        Start-Sleep -s 300
        Import-Module -Name SQLPS
        $sql = "
        CREATE DATABASE [TMMDATABASE]
         CONTAINMENT = NONE
         ON PRIMARY
        ( NAME = N'TMMDATABASE', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\TMMDATABASE.mdf', SIZE = 1508356KB, FILEGROWTH = 2018523KB)
         LOG ON
        ( NAME = N'TMMDATABSE_log', FILENAME = N'C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\TMMDATABASE_log.ldf', SIZE = 524288KB, FILEGROWTH = 625321KB)
        GO

        USE [master]
        GO
        ALTER DATABASE [TMMDATABASE] SET RECOVERY SIMPLE WITH NO_WAIT
        GO

        ALTER AUTHORIZATION ON DATABASE::[TMMDATABASE] to [sa]
        GO"
        $machname = '${resource.Cloud_vSphere_Machine_1.resourceName}'
        Invoke-SqlCmd -ServerInstance $machname -Query $sql
      reboot: 0
