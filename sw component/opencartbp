formatVersion: 1
inputs:
  username:
    type: string
    title: System Admin Account Username
    default: demouser
    description: The username you would like to have for the installation.
  password:
    type: string
    pattern: '[a-z0-9A-Z@#$]+'
    encrypted: true
    default: vRealiz3!
    title: OpenCart Admin Account Password
    description: The password you would like to use for the ocuser account.
  MachineName:
    type: string
    title: Name for the DB VM
    description: Enter Name for DB Server.
  MachineName2:
    type: string
    title: Name for the Frontend VM
    description: Enter Name for Frontend Server.
resources:
  Frontend_Server:
    type: Cloud.vSphere.Machine
    dependsOn:
      - MySQL_Server
    properties:
      image: Ubuntu-18
      flavor: medium
      newName: '${input.MachineName2}'
      cloudConfig: |
        users:
          - name: ${input.username}
            sudo: ['ALL=(ALL) NOPASSWD:ALL']
            groups: sudo
            shell: /bin/bash

        runcmd:
          - USER=${input.username}
          - PASS=${input.password}
          - echo $USER:$PASS | /usr/sbin/chpasswd
          - echo ${input.username}:$PASS | /usr/sbin/chpasswd
          - sed -i "s/PasswordAuthentication no/PasswordAuthentication yes/g" /etc/ssh/sshd_config
          - service ssh reload
      networks:
        - network: '${resource.Cloud_vSphere_Network_1.id}'
  MySQL_Server:
    type: Cloud.vSphere.Machine
    properties:
      image: Ubuntu-18
      flavor: medium
      newName: '${input.MachineName}'
      cloudConfig: |
        users:
          - name: ${input.username}
            sudo: ['ALL=(ALL) NOPASSWD:ALL']
            groups: sudo
            shell: /bin/bash

        runcmd:
          - USER=${input.username}
          - PASS=${input.password}
          - echo $USER:$PASS | /usr/sbin/chpasswd
          - echo ${input.username}:$PASS | /usr/sbin/chpasswd
          - sed -i "s/PasswordAuthentication no/PasswordAuthentication yes/g" /etc/ssh/sshd_config
          - service ssh reload
      networks:
        - network: '${resource.Cloud_vSphere_Network_1.id}'
      constraints:
        - tag: 'env:vsphere'
  Cloud_vSphere_Network_1:
    type: Cloud.vSphere.Network
    properties:
      networkType: existing
      constraints:
        - tag: 'env:vsphere'
  Install_MySQL:
    type: Custom.script
    dependsOn:
      - Reboot_Server
    properties:
      vcuser: mcclanahanc@cmbu.local
      vcpassword: ***
      vcfqdn: ***
      remoteuser: '${input.username}'
      remotepassword: '${input.password}'
      machinename: '${resource.MySQL_Server.resourceName}'
      script: |
        sudo apt update -y
        sudo apt install mysql-server-5.7 -y
        sudo apt install mysql-client -y
        sudo apt install unzip
        export DEBIAN_FRONTEND=noninteractive
        export USER=${input.username}
        sudo hostnamectl set-hostname ${input.MachineName}
        echo "mysql-server-5.7 mysql-server/root_password password root" | sudo debconf-set-selections
        echo "mysql-server-5.7 mysql-server/root_password_again password root" | sudo debconf-set-selections
        touch ~/mysql.cnf
        echo "[client]" >> ~/mysql.cnf
        echo "user=root" >> ~/mysql.cnf
        echo "password=root" >> ~/mysql.cnf
        sudo chmod 777 /etc/mysql/mysql.conf.d/mysqld.cnf
        sudo sed -i 's/#slow/slow/g' /etc/mysql/mysql.conf.d/mysqld.cnf
        sudo sed -i 's/#long_query_time/long_query_time/g' /etc/mysql/mysql.conf.d/mysqld.cnf
        sudo sed -i 's/bind-address/#bind-address/g' /etc/mysql/mysql.conf.d/mysqld.cnf
        sudo chmod 444 /etc/mysql/mysql.conf.d/mysqld.cnf
        sudo systemctl restart mysql
        sudo mysql --defaults-extra-file=~/mysql.cnf -e "CREATE USER '$USER'@'%' IDENTIFIED BY 'Password123'"
        sudo mysql --defaults-extra-file=~/mysql.cnf -e "GRANT ALL ON *.* TO '$USER'@'%' IDENTIFIED BY 'Password123'"
        sudo mysql --defaults-extra-file=~/mysql.cnf -e 'CREATE DATABASE opencart'
        sudo mysql --defaults-extra-file=~/mysql.cnf -e 'USE opencart'
        sudo mysql --defaults-extra-file=~/mysql.cnf -e 'flush privileges'
      reboot: 0
  Reboot_Server:
    type: Custom.script
    dependsOn:
      - MySQL_Server
    properties:
      vcuser: mcclanahanc@cmbu.local
      vcpassword: ***
      vcfqdn: ***
      remoteuser: '${input.username}'
      remotepassword: '${input.password}'
      machinename: '${resource.MySQL_Server.resourceName}'
      script: echo "Do Nothing"
      reboot: 1
  Reboot_Frontend:
    type: Custom.script
    dependsOn:
      - Frontend_Server
    properties:
      vcuser: mcclanahanc@cmbu.local
      vcpassword: ***
      vcfqdn: ***
      remoteuser: '${input.username}'
      remotepassword: '${input.password}'
      machinename: '${resource.Frontend_Server.resourceName}'
      script: echo "Do Nothing"
      reboot: 1
  Install_OpenCart:
    type: Custom.script
    dependsOn:
      - Reboot_Frontend
    properties:
      vcuser: mcclanahanc@cmbu.local
      vcpassword: Mazie@123
      vcfqdn: sc2vc03.cmbu.local
      remoteuser: '${input.username}'
      remotepassword: '${input.password}'
      machinename: '${resource.Frontend_Server.resourceName}'
      script: |
        sudo apt update -y
        sudo apt install apache2 -y
        sudo apt install php -y
        sudo apt install php-mysql -y
        sudo apt install libapache2-mod-php -y
        sudo apt install php-mcrypt -y
        sudo apt install php-gd -y
        sudo apt install php-mbstring -y
        sudo apt install php-xml -y
        sudo apt install php-zip -y
        sudo apt install php-curl -y
        sudo apt install mysql-server-5.7 -y
        sudo apt install unzip -y
        export USER=${input.username}
        sudo hostnamectl ${input.MachineName2}
        git clone https://github.com/mcclanc/opencart-demo.git /tmp/opencart
        sudo mv /tmp/opencart /var/www/
        sudo chown -R www-data.www-data /var/www/opencart
        sudo chmod -R 775 /var/www/opencart
        sudo tee /etc/apache2/sites-available/opencart.conf > /dev/null << EOF
        <VirtualHost *:80>
          ServerName www.opencart.cmbu.local
          DocumentRoot /var/www/opencart
          <Directory /var/www/opencart/>
            AllowOverride All
            allow from all
          </Directory>
        </VirtualHost>
        EOF
        cd /etc/apache2/sites-available/
        sudo a2ensite opencart.conf
        sudo a2dissite 000-default.conf
        sudo systemctl reload apache2
        sudo systemctl restart apache2
        echo "[client]" >> ~/mysql.cnf
        echo "user=${input.username}" >> ~/mysql.cnf
        echo "password=Password123" >> ~/mysql.cnf
        export onpremip=$(ip route get 8.8.8.8 | awk -F"src " 'NR==1{split($2,a," ");print a[1]}')
        export mysqlip=${resource.MySQL_Server.networks[0].address}
        export ip4=$onpremip
        sudo mysql --defaults-extra-file=~/mysql.cnf -h $mysqlip -e 'source /var/www/opencart/install/opencart.sql'
        sudo mysql --defaults-extra-file=~/mysql.cnf -h $mysqlip -e "INSERT INTO oc_user (user_id,user_group_id,username,password,salt,firstname,lastname,email,image,code,ip,status,date_added) VALUES (1,1,'admin','5feaa046f6927df3d744007ec1491dba838f672e','c4wnfrq9J','demo','user','admin@admin.com','none','none','none',1,'2019-01-31 06:29:09')" opencart
        sudo sed -i "s/frontendiphere/$ip4/g" /var/www/opencart/config.php
        sudo sed -i "s/dbiphere/$mysqlip/g" /var/www/opencart/config.php
        sudo sed -i "s/usernamehere/$USER/g" /var/www/opencart/config.php
        sudo sed -i "s/passwordhere/Password123/g" /var/www/opencart/config.php
        sudo sed -i "s/frontendiphere/$ip4/g" /var/www/opencart/admin/config.php
        sudo sed -i "s/dbiphere/$mysqlip/g" /var/www/opencart/admin/config.php
        sudo sed -i "s/usernamehere/$USER/g" /var/www/opencart/admin/config.php
        sudo sed -i "s/passwordhere/Password123/g" /var/www/opencart/admin/config.php
        sudo systemctl reload apache2
        sudo systemctl restart apache2
        echo 'Install is done!' >> /tmp/finished.txt
      reboot: 0